## HTTPS

> **超文本传输安全协议**（英语：*HyperText Transfer Protocol Secure*，缩写：HTTPS；常称为 HTTP over TLS、HTTP over SSL 或 HTTP Secure）是一种**通过计算机网络进行安全通信的传输协议**。
>
> HTTPS经由HTTP进行通信，但利用SSL/TLS来加密数据包。HTTPS开发的主要目的，是提供对网站服务器的**身份认证**，保护交换资料的**隐私与完整性**。这个协议由网景公司（Netscape）在1994年首次提出，随后扩展到互联网上。
>
> 历史上，HTTPS连接经常用于万维网上的交易支付和企业信息系统中敏感信息的传输。在2000年代末至2010年代初，HTTPS开始广泛使用，以确保各类型的网页真实，保护账户和保持用户通信，身份和网络浏览的私密性。
>
> 另外，还有一种安全超文本传输协议（S-HTTP）的HTTP安全传输实现，但是HTTPS的广泛应用而成为事实上的HTTP安全传输实现，S-HTTP并没有得到广泛支持。
>
> 随着传输层安全协议（Transport Layer Security，TLS）的发展，目前我们已经使用  TSL 取代了废弃的 SSL（Secure Sockets Layer，SSL）保证数据传输的**安全**。



### 概述

HTTPS 是对 HTTP 协议的扩展，我们可以使用它在互联网上安全的传输数据，要学习 HTTPS 需要了解：

-  TCP 协议
- TSL 协议
- HTTP 协议
- 加密算法（对称加密和非对称加密）
- 证书与数字签名

阅读本文之前，希望你对上述有所了解。



### 握手

你可能被问到过这样的问题：

> 从我们在地址栏敲下 https:// 网站那一刹那, 到内容显示到我们面前, 中间经过了哪些过程了? 浏览器根据什么来判断, 当前网站网址是安全的还是未验证的? 



#### 大白话概览

<img src="../assets/image-20210318152719216.png" alt="image-20210318152719216" style="zoom:50%;" />



#### RFC 5246

<img src="../assets/image-20210318153645068.png" alt="image-20210318153645068" style="zoom:50%;" />



> ```c
> Note: To help avoid pipeline stalls, ChangeCipherSpec is an independent TLS protocol content type, and is not actually a TLS handshake message.
> 
> When the client and server decide to resume a previous session or duplicate an existing session (instead of negotiating new security parameters), the message flow is as follows:
> 
> The client sends a ClientHello using the Session ID of the session to be resumed.  The server then checks its session cache for a match. If a match is found, and the server is willing to re-establish the connection under the specified session state, it will send a ServerHello with the same Session ID value.  At this point, both client and server MUST send ChangeCipherSpec messages and proceed directly to Finished messages.  Once the re-establishment is complete, the client and server MAY begin to exchange application layer data.  (See flow chart below.)  If a Session ID match is not found, the server generates a new session ID, and the TLS client and server perform a full handshake.
> ```



<img src="../assets/image-20210318155732583.png" alt="image-20210318155732583" style="zoom:50%;" />



#### 握手各环节分析

```c
1. Hello Messages
   1. Hello Request
   2. Client Hello
   3. Server Hello
   4. Hello Extensions
      1. Signature Algorithms
2. Server Certificate
3. Server Key Exchange Message
4. Certificate Request
5. Server Hello Done
6. Client Certificate
7. Client Key Exchange Message
   1. RSA-Encrypted Premaster Secret Message
   2. Client. Diffie-Hellman Public Value
8. Certificate Verify
9. Finished
```



### 吊销检查

> 目前写进国际标准的吊销状态检查协议有两种: 
>
> 1. CRL
>
> CRL 由认证中心创建并进行数字签名的已撤销公钥证书的列表。它是一份全量的文件，记录了被此 CRL 限制的证书中所有被吊销证书的序列号。
>
> <img src="../assets/image-20210318162536302.png" alt="image-20210318162536302" style="zoom:50%;" />
>
> 2. OCSP
>
> OCSP 是  TCP 服务，通过请求证书序列号，服务器告知当前序列号是否在被吊销名单中。是目前的主流！
>
> <img src="../assets/image-20210318162518012.png" alt="image-20210318162518012" style="zoom:50%;" />
>
> 两者对比：
>
> OCSP 的优点是它比传统的 CRL 检查过程要快，并且还提供有关证书吊销状态的最新信息。但是在某些情况下，CRL 可能更有利（主要是在 OCSP 服务器出现故障时-甚至只是暂时的）。
>
> 缺点：
>
> CRL 列表增加，CA 发布新列表。由于基于 CRL 的验证方法要求对每个连接进行证书吊销状态检查，因此 CRL 颁发者或 CA 可能会发布新列表，而您将错过新吊销的证书。这不利于可伸缩性。
>
> 这两种方法对于客户端来说都是资源密集型的。它们占用了大量资源，并且也增加了延迟。这导致更糟糕的用户体验。毕竟，客户端每次必须在该列表上通过很多证书。
>
> 您的隐私保护渠道存在一些漏洞。使用 OCSP 时，您对网站的安全使用并不像您想象的那样安全。为什么？因为浏览器告诉 CA 服务器谁正在访问哪些网站。因此，如果您不希望任何人（包括 CA）知道您对可收藏的小雕像或猫视频的喜爱，那么用户请当心。
>
> CRL 和 OCSP 依赖于 CA 的基础结构。如果您使用的 CA 不可靠，并且服务器停机时间或可用性问题很多，那么依赖这两种做法就会更加麻烦。
>
> 但是，主要的危险信号是浏览器的 CRL 检查软故障策略。我的意思是，当客户端检查 CRL 列表，或者他们向 OCSP 响应者发送消息并获得“未知”响应时，某些浏览器可能会认为证书有效并且允许连接，而不考虑潜在的危险。
>
> 
>
> ps. 
>
> 1. 有的证书内置了 CRL + OCSP，有的只是内置了 OCSP 或者 CRL，但是只内置 CRL 的证书是不被新型浏览器信任了。
> 2. 吊销状态检查是同步的、不可逆的。

### 参考

- [The Transport Layer Security (TSL) Protocol Version 1.2](https://tools.ietf.org/html/rfc5246) chapter 7.3-7.4
- [超文本传输安全协议](https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE)
- [什么是证书吊销列表？](https://www.asiaregister.com/zh/news/CRL-jie-shi-shen-me-shi-zheng-shu-diao-xiao-lie-biao-2228.htm)

































