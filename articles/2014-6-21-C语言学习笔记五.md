---
title: C 语言学习笔记五
date: 2014-06-21 16:53:03
categories:
- C
tags:
- C
- 宏定义
---

## 宏定义

C语言在对源程序进行**编译之前**，会先对一些特殊的**预处理指令**作解释(比如经常见到的`#include`文件包含指令)，产生一个新的源程序（这个过程称为**编译预处理** ），之后再进行通常的**编译**

为了区分预处理指令和一般的C语句，所有预处理指令都**以符号`#`开头，并且结尾不用分号**

预处理指令可以出现在程序的**任何位置**，它的作用范围是**从它出现的位置到文件尾**。习惯上我们尽可能将预处理指令写在源程序开头，这种情况下，它的作用范围就是整个源程序文件

文中，我要讲的**宏定义**正式C语言提供的预处理指令的重要内容之一。

 <!--more-->

## 不带参数的宏定义

### #define 宏名 字符串

```c
#include <stdio.h>
#include <string.h>

// 源程序中所有的宏名 HOST 在编译预处理的时候都会被kai-lee.com所代替
#define KHOST "kai-lee.com"
#define KSCHEME "https://"
#define KURL strcat(KSCHEME,KHOST)

int main ()
{
    char *test = "输出：";
    printf("%s%s", test, KHOST);
	printf("%s%s", test, KURL);
    return 0;
}
```

### 注意

- 宏名一般用大写字母，以便与变量名区别开来，但用小写也没有语法错误
- 在编译预处理用字符串替换宏名时，不作语法检查，只是简单的字符串替换。只有在编译的时候才对已经展开宏名的源程序进行语法检查
- 宏名的有效范围是从定义位置到文件结束。如果需要终止宏定义的作用域，可以用`#undef`命令
- 定义一个宏时可以引用已经定义的宏名



## 带参数的宏定义

### #define 宏名(参数列表) 字符串

```c
#include <stdio.h>

#define AVG(a, b) (a+b)/2

int main ()
{
    int a = AVG(10, 4);
    // 平均值：7
    printf("平均值：%d", a);
    return 0;
}
```

### 注意

- **宏名和参数列表之间不能有空格**，否则空格后面的所有字符串都作为替换的字符串
- 带参数的宏在展开时，**只作简单的字符和参数的替换**，不进行任何计算操作。所以在定义宏时，一般用一个小括号括住字符串的参数

```c
	int a = AVG(10+2, 4);
	// 平均值：(10+4)/2+(2+4)/2 = 10
    printf("平均值：%d", a);
```



- 计算结果最好也用括号括起来



## 宏定义与函数的区别

从整个使用过程可以发现，带参数的宏定义，在源程序中出现的形式与函数很像。但是两者是有本质区别的：

- 宏定义不涉及**存储空间的分配、参数类型匹配、参数传递、返回值**问题

-  函数调用在程序运行时执行，而宏替换只在编译预处理阶段进行。所以带参数的宏比函数具有更高的执行效率



## 参考文献

- [美]Prate,S. C Primer Plus[M]. 第5版. 云巅工作室，译. 北京：人民邮电出版社，2011.4：60-85.

- [【C语言】15-预处理指令1-宏定义](https://www.cnblogs.com/mjios/archive/2013/03/20/2969817.html)