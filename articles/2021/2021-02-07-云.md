## 我听了一场 “上云“ 技术分享的整理

### 背景

就在上周，听了关于**后端架构服务的技术分享会**。作为一个移动开发的 iOS 小菜鸡，仰慕之情如滔滔江水绵绵不绝，汇成一句：好家伙！

<img src="../../assets/image-20210207104159452.png" alt="image-20210207104159452" style="zoom:45%;" />

云，这个概念其实也不是什么新鲜概念了，比较直观的可以看到各大一线互联网公司都有了自己的公有云产品：阿里云、腾讯云、华为云、百度云、美团云。。。

对于一个开发人员，怎么样理解 **云** 呢？一下是仅仅是我作为一个互联网从业者的理解，错误的地方，还请指正，轻喷。（满满的求生欲！！！）

故事的开始，我想先问一下在读的小伙伴：**你去过机房吗？** 这里的机房可不是你上课的时候的微机教室哈。。。

<img src="../../assets/image-20210207105920285.png" alt="image-20210207105920285" style="zoom:50%;" />

<img src="../../assets/image-20210207110010965.png" alt="image-20210207110010965" style="zoom:50%;" />



> 参考：
>
> [数据中心](https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%BF%83)
>
> [服务器机房](https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9C%BA%E6%88%BF)

如图1，规模规格比较高大上，现在有了更响亮的名字： **数据中心**。

图2，是几个机架。

我去过两次，里边的第一感受是冻得慌 zzz

那时候我们公司还没有“上云”，我们只是租了联通机房的几个机架，利用联通机房提供的基础设施（电、空调、宽带等等）在机架上摆了几台我们从浪潮买的服务器，你可别小看这几台服务器，我们公司的运维工程师把他当宝贝呢！！！

现在我回想起那段记忆已经模糊了，运维工程师估计还记得很清楚，但是估计现在他也很少去机房了吧。。。

没错，“云” 来了！

随着互联网的迅猛发展，“云”因运而生！现在我们只需要将应用部署到云端就可以了，不必再关注那些令人头疼的硬件和软件问题，而公司或团队只需要为**由云服务提供商的专业团队的服务**买单！比如：购买计算能力8核 16核。。。购买存储1G 10G 100G。。。

物理上一个明显的转变：

<img src="../../assets/image-20210207113329495.png" alt="image-20210207113329495" style="zoom:50%;" />

> [云计算](https://zh.wikipedia.org/wiki/%E9%9B%B2%E7%AB%AF%E9%81%8B%E7%AE%97)
>
> 云计算依赖资源的共享以达成[规模经济](https://zh.wikipedia.org/wiki/規模經濟)，类似[基础设施](https://zh.wikipedia.org/wiki/基礎設施)（如电力网）。服务提供者集成大量的资源供多个用户使用，用户可以轻易的请求（租借）更多资源，并随时调整使用量，将不需要的资源释放回整个架构，因此用户不需要因为短暂尖峰的需求就购买大量的资源，仅需提升租借量，需求降低时便退租。服务提供者得以将目前无人租用的资源重新租给其他用户，甚至依照整体的需求量调整租金。
>
> 基本特征[[编辑](https://zh.wikipedia.org/w/index.php?title=雲端運算&action=edit&section=2)]
>
> [互联网](https://zh.wikipedia.org/wiki/互联网)上汇聚的计算资源、存储资源、数据资源和应用资源正随着互联网规模的扩大而不断增加，互联网正在从传统意义的通信平台转化为泛在、智能的计算平台。与计算机系统这样的传统计算平台比较，互联网上还没有形成类似计算机[操作系统](https://zh.wikipedia.org/wiki/操作系统)的服务环境，以支持互联网资源的有效管理和综合利用。在传统计算机中已成熟的操作系统技术，已不再能适用于互联网环境，其根本原因在于：互联网资源的自主控制、自治对等、异构多尺度等基本特性，与传统计算机系统的资源特性存在本质上的不同。为了适应互联网资源的基本特性，形成承接互联网资源和互联网应用的一体化服务环境，面向互联网计算的**虚拟计算环境**（Internet-based Virtual Computing Environment，iVCE）的研究工作，使用户能够方便、有效地共享和利用开放网络上的资源。[[6\]](https://zh.wikipedia.org/wiki/雲端運算#cite_note-6)[[7\]](https://zh.wikipedia.org/wiki/雲端運算#cite_note-7)[[8\]](https://zh.wikipedia.org/wiki/雲端運算#cite_note-8)[[9\]](https://zh.wikipedia.org/wiki/雲端運算#cite_note-9)[[10\]](https://zh.wikipedia.org/wiki/雲端運算#cite_note-10)[[11\]](https://zh.wikipedia.org/wiki/雲端運算#cite_note-11)
>
> 互联网上的云计算服务特征和自然界的[云](https://zh.wikipedia.org/wiki/云)、[水循环](https://zh.wikipedia.org/wiki/水循环)具有一定的相似性，因此，云是一个相当贴切的比喻。根据美国国家标准和技术研究院的定义，云计算服务应该具备以下几条特征：[[12\]](https://zh.wikipedia.org/wiki/雲端運算#cite_note-nist-12)
>
> - 随需应变自助服务。
> - 随时随地用任何网络设备访问。
> - 多人共享资源池。
> - 快速重新部署灵活度。
> - 可被监控与量测的服务。
>
> 一般认为还有如下特征：
>
> - 基于虚拟化技术快速部署资源或获得服务。
> - 减少用户终端的处理负担。
> - 降低了用户对于IT专业知识的依赖。



### 后端大佬口中的平滑迁移

想必是大势所趋，我司也进行过上云运动。这里解释一下**上云**：从 `IDC`-->`cloud`

听着大佬的经验分享，仿佛我也身处在那场硝烟弥漫的战斗中。。。

抛开技术细节不说，大抵经历了：

1. 云服务商招标
2. 需求准备，厂商对接
3. 探讨方案，谈报价
4. 存成方案，报价收官
5. 高层决策
6. 具体实施

上云的过程：

- 调研评估
  - 服务梳理
  - 设备、算力、资源的选择
  - 指定具体的实施规范和方案
- 迁移准备
  - 业务梳理
  - 网络专线
  - 容器平台
  - 日志、监控等
- 迁移与割接
  - 服务部署
  - 数据迁移
  - 流量切割
  - 服务观测与保障
  - 应急处理
- 资源回收
  - 服务清理
  - 数据清理
  - 合同终止
  - 设备售卖（商务）

通用的迁移方案分享：（本着先易后难的方向）

- 运行环境：测试环境-->预发布环境-->生产环境
- 服务等级：非核心服务-->核心服务
- 资源类型：先切读，后切写
- 复杂业务：拆解模块，分批次
- 过渡期方案
- 兼容性方案
- 回退方案

上云之后：

- 故障管理
- 灾备建设
- 监控完善
- 应急响应
- 持续的优化

ps. 集群、容器、负载均衡、灾备等等我根本说不清楚的内容以及名词，还是需要自行查阅资料。

<img src="../../assets/image-20210207141059276.png" alt="image-20210207141059276" style="zoom:50%;" />



作为一名 iOS 开发，我听完了整场的后端上云架构技术分享，当然不能指望通过一场技术分享就能够学到什么东西？但是，分享者传达出来的思考方式、技术热度与技术方向都很值得我去学习。如果有机会，我还会去听一些这样的技术分享，可以打开我的思路，拓宽我的技术边界，不能做井底之蛙！！！

我感觉技术分享，对于分享者的收获远大于听众！因为把一个技术难点、一项新兴的技术通俗易懂的传达给大家，自己肯定是要有足够的认知！作为听众，也别以为听了一场技术分享就什么都会了，其实你只是看到了一点皮毛！

作为一个开发工程师，不断学习，才能免于淘汰！学如逆水行舟，不进则退！







Q&A

- 上行数据和下行数据

上行速率就是发送出去数据的速度，下行就是收到数据的速度。比如，目前我们使用的 ADSL 是非对称的传输方式，即上行速率不等于下行速率；ADSL上行速率 640Kbps 到 1Mbps，下行速率 1Mbps 到 8Mbps。普遍的是2Mbps



-  华为云 OBS 单AZ和多AZ有什么区别？

**问题一：**

Q：创建桶时，数据冗余存储策略选择单AZ存储和多AZ存储有什么区别？

A：选择多AZ存储，数据将冗余存储至多个AZ中，可靠性更高。选择单AZ存储，数据仅存储在单个AZ中，但相比多AZ更加便宜。收费详情请参见[产品价格详情](https://www.huaweicloud.com/pricing.html?tab=detail#/obs)。

**问题二：**

Q：选择多AZ存储后，数据是以副本的形式分别存放在多个AZ中吗？如果某个AZ出现故障，其他AZ中的数据是否完整？

A：多AZ采用Erasure Code（EC，纠删码）算法做数据冗余，不是以副本的形式存储。选择多AZ存储的桶，数据将存储在同一区域的多个不同AZ。当某个AZ不可用时，仍然能够从其他AZ正常访问数据，适用于对可靠性要求较高的数据存储场景。目前多AZ只支持一个AZ故障。

**问题三：**

Q：在不删除桶的前提下能否更改数据冗余存储策略？

A：不能。桶一旦创建成功，数据冗余存储策略就确定了，后续无法更改。可以考虑将数据迁移至新创建的桶，以实现数据冗余存储策略修改。

- 单数据中心架构

高可用的后端服务不是一蹴而就的！

所谓单数据中心架构。主要包括分布式计算、存储、安全网络等多种分布式技术的合集。

多个数据中心的分布式架构主要是指将传统多个数据中心统一整合为一个数据中心。 实现业务连续性灾备，多中心运营和管理等。 例如：将多个不同地区，不同规模的数据中心使用统一的管理平台进行资源的统一管理，使用统一的运营平台实现统一运行。

>
>
> ### 云上容灾架构设计与方案
>
>随着医疗、大型企业行业上云步伐的加快，上云后的业务系统安全性如何保障成为客户关注的重点。对于医疗、大型企业客户，往往建有自己的数据中心，如何保障极端情况下业务系统的稳定运行？双活、灾备，能帮到我们！
>
>**一、单数据中心架构的隐患**
>
>
>
>单数据中心的常见架构如下图所示，如果在该数据中心在极端情况下，出现网络全阻、设备掉电全阻等情况，业务可能发生全阻。大型数据中心一般为多路由的网络、电源拉入，出现此类情况的概率极低，但对于医疗、金融等客户，也会带来灾难。
>
>在此架构下，一般建议至少买两台云主机，挂在[负载均衡](https://cloud.tencent.com/product/clb?from=10680)下面，避免单云主机出现业务中断。同时数据库与web、应用服务器不建议放在同一台云主机上，避免互相争抢资源，云端建议买RDS Paas服务，减少麻烦。
>
><img src="../../assets/image-20210716164352505.png" alt="image-20210716164352505" style="zoom:50%;" />
>
>**二、云上多AZ的应用高可用方案**
>
>
>
>一些云服务商在同一个城市部署了两个数据中心，中间通过高速的二层网络形成互连，形成了双AZ（可用区）的架构。
>
>1、当可用区1的主用SLB中断时，会将IP地址浮动至可用区2的备用SLB上。该方式是通过BGP路由的动态路由检测来完成。
>
>2、当可用区1的主用ECS全部中断时，主用SLB会将业务流量倒至备用区的ECS。因此高速的二层网络将在此时承担大量的数据流量。
>
>3、当可用区1的主用RDS中断时，也将该主用RDS的ip地址浮动至可用区2的备用RDS库中。
>
><img src="../../assets/image-20210716164423484.png" alt="image-20210716164423484" style="zoom:50%;" />
>
>**三、线上、线下结合的应用高可用方案**
>
>
>
>如果希望将公有云及企业自建的私有云进行联动，可以采用如下的系统架构，该方式与双AZ方式有很大的区别。
>
>1、通过智能DNS服务，实时两个SLB的连通性进行检测，当主用SLB中断时，进行秒极的检测，将备用SLB同步至全网的DNS服务器。
>
>2、如果两朵云都是客户自建的，则可以通过高速网络进行二层互通，实现云主机的分组，相互倒流。
>
>3、对于数据库的同步，可以通过数据库自带的脚本，或采用第三方的工具进行数据库的日志级同步。
>
><img src="../../assets/image-20210716164445735.png" alt="image-20210716164445735" style="zoom:50%;" />
>
>**四、两地三中心的应用双活架构**
>
>
>
>该架构实际是以上两种方式的结合。双活架构一般是发生是两个数据中心相邻距离不远的场景。如果对于金融级的客户，还会考虑异地的灾备。则采用以下的架构。保障双活的公有云中断时，异地的私有云还能够在一定的时间内接管业务。
>
><img src="../../assets/image-20210716164507676.png" alt="image-20210716164507676" style="zoom:50%;" />
>
>**五、数据灾备级的容灾方案**
>
>
>
>对于以上的方案，投入的代价较大，例如需要支付双活数据中心的高速通道费用、相同配置的云主机费用。因此对于一般中型企业，也会提出将数据进行灾备，保障当主用数据中心中断时，原有的私有云能够在几个小时的时间内容逐步恢复业务系统的运行。
>
>该方案实际是企业用得较多的形式，就算业务没有恢复，但数据还在我自己的机房中有备份。
>
>业内的实际方案较多，有基于硬件的灾备一体机，也有纯软件实现的方案。
>
>1、例如下图，本地通过灾备一体机进行数据的压缩、加密、存储，同时在云端也进行一份灾备存储。这样当业务系统中断时，可以选择在云端恢复、或线下私有云恢复。
>
><img src="../../assets/image-20210716164540005.png" alt="image-20210716164540005" style="zoom:50%;" />
>
>2、例如下图，也可以通过纯软件的方式进行灾备，直接将备份的文件放下云端、或线下私有云。
>
><img src="../../assets/image-20210716164613205.png" alt="image-20210716164613205" style="zoom:50%;" />
>
>这两种方式本质上都是文件级的灾备方案，因此对于数据库等高可靠性的业务支撑不如日志级的数据同步方案。建议将灾备的周期可以设置为一小时及以上，以保障数据库的运行稳定安全。同时为避免数据库在异常情况下无法恢复，建议使用原厂的工具进行数据实时日志级同步，如Oracle DG、Mysql的主从脚本等。
>
>
>
>**六、小结**
>
>
>
>1、如果中型企业、资金预算较充足，可以选择双AZ方案、或线上+线下的双活高可用方案。
>
>2、对于金融级客户，可以选择两地三中心的方案。
>
>3、对于普通企业客户，可以选择数据级的灾备方案。



