## iOS é—®é¢˜

### 1. å‘ç‰ˆé—®é¢˜

1. ç‰ˆæœ¬å‘½åé—®é¢˜

<img src="../../assets/operationError.png" alt="æˆªå±2020-04-23 ä¸‹åˆ4.31.04" style="zoom:50%;" />



> ERROR ITMS-90060: "This bundle is invalid. The value for key CFBundleShortVersionString '9.3.1.0' in the Info.plist file at 'Payload/Koala.app' must be a period-separated list of at most three non-negative integers. Please find more information about CFBundleShortVersionString at https://developer.apple.com/documentation/bundleresources/information_property_list/cfbundleshortversionstring"

#### è§£å†³åŠæ³•

åŸºæœ¬å®ç°æ€è·¯ï¼š

æ·»åŠ ä¸€ä¸ªè‡ªå·±ç®¡ç†çš„é…ç½®é¡¹å€¼ sys-clientVersionï¼Œï¼ˆæ‰€æœ‰å±•ç¤ºç›¸å…³å…¨ç”¨è¯¥å€¼ï¼‰ï¼Œä¸Šä¼ App Storeï¼Œæ–°ç‰ˆæœ¬å†™æˆ sys-clientVersion ä¸€æ ·çš„å€¼å³å¯ã€‚

å‚è€ƒï¼š[iOS APPä»æ‰“åŒ…åˆ°å‘å¸ƒappStoreå®Œæ•´æµç¨‹ï¼ˆå«4ä½ç‰ˆæœ¬å·å®ç°ï¼‰](https://www.jianshu.com/p/860fdd8860cc)





2. åœ¨iTunes Connect é‡Œæ–°å»ºäº†é¡¹ç›®ï¼Œå¯¼å…¥iconå›¾ç‰‡æ—¶ï¼Œé‡åˆ°ä»¥ä¸‹é—®é¢˜

<img src="../../assets/image-20200928162607268.png" alt="image-20200928162607268" style="zoom:50%;" />





### 2. AFNetworking

**æŠ¥é”™:(415 Domain=com.alamofire.error.serialization.response Code=-1011 "Request failed: unsupported media type (415)")**

è§£å†³ï¼šåœ¨å¯¹è¯·æ±‚æ•°æ®æ ¼å¼å’Œå“åº”**æ•°æ®æ ¼å¼**åˆå§‹åŒ–çš„æ—¶å€™,å°†ä¹‹å‰çš„çˆ¶ç±»ï¼ˆAFHTTPRequestSerializerï¼‰æ¢æˆäº†å®ƒçš„å­ç±»(AFJSONRequestSerializerï¼‰

```objective-c
manager.requestSerializer = [AFJSONRequestSerializer serializer];
manager.responseSerializer = [AFJSONResponseSerializer serializer];
```



### 3. GCD

æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š

[å¤šçº¿ç¨‹ç¼–ç¨‹çŸ¥è¯†æ•´ç†](./articles/2018-12-02-iOS-å¤šçº¿ç¨‹ç¼–ç¨‹çŸ¥è¯†æ•´ç†.md)

[iOS-å¤šçº¿ç¼–ç¨‹ä¹‹çº¿ç¨‹å®‰å…¨](./articles/2018-12-11-iOS-å¤šçº¿ç¼–ç¨‹ä¹‹çº¿ç¨‹å®‰å…¨.md)

[iOSå¤šçº¿ç¨‹ä¹‹åŒæ­¥å¼‚æ­¥ã€ä¸²è¡Œå¹¶è¡Œ](./articles/2018-12-18-iOSå¤šçº¿ç¨‹ä¹‹åŒæ­¥å¼‚æ­¥ã€ä¸²è¡Œå¹¶è¡Œ.md)

[Runloopä¸çº¿ç¨‹ä¿æ´»](./articles/2018-12-15-iOS-Runloopä¸çº¿ç¨‹ä¿æ´».md)



iOS å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨ GCD æ¥å¤„ç†å¹¶å‘ã€‚æˆ‘ä»¬å¹¶ä¸å…³å¿ƒçº¿ç¨‹çš„ç®¡ç†ï¼Œå¼€å¤šå°‘çº¿ç¨‹æ˜¯ç”± GCD å°è£…çš„çº¿ç¨‹æ± å†³å®šçš„ï¼ˆå»ºè®®3~5æ¡ï¼‰ï¼Œçº¿ç¨‹æ± ç”±ç³»ç»Ÿè‡ªåŠ¨æ¥ç»´æŠ¤ã€‚æˆ‘ä»¬é€šå¸¸çš„æ“ä½œæ˜¯å‘**é˜Ÿåˆ—**ä¸­æ·»åŠ **ä»»åŠ¡**ï¼Œé˜Ÿåˆ—è°ƒåº¦å³å¯ï¼

![](../../assets/dispatchQueue2018.png)

é—®é¢˜ï¼šå–æ¶ˆæ“ä½œï¼ˆä»»åŠ¡ï¼‰ åœ¨ GCD ä¸­ï¼Œæ˜¯æ²¡åŠæ³•å¯¹æ·»åŠ åˆ° `queue` çš„ `task` è¿›è¡Œ `cancel`æ“ä½œçš„ï¼**ps. è¿™é‡Œçš„å–æ¶ˆåªé’ˆå¯¹å°šæœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¯¹æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¸èµ·ä½œç”¨ï¼ï¼ï¼**

æ–¹æ¡ˆ1ï¼š**dispatch_block_cancel**

iOS 8 ä»¥åï¼Œå¯ä»¥è°ƒç”¨ **dispatch_block_cancel** æ¥å–æ¶ˆç”¨ **dispatch_block_create** åˆ›å»ºçš„ **dispatch_block_t**

```objective-c
- (void)gcdBlockCancel{
    dispatch_queue_t queue = dispatch_queue_create("com.gcdtest", DISPATCH_QUEUE_CONCURRENT);
    
    dispatch_block_t block1 = dispatch_block_create(0, ^{
        sleep(5);
        NSLog(@"block1 %@",[NSThread currentThread]);
    });
    
    dispatch_block_t block2 = dispatch_block_create(0, ^{
        NSLog(@"block2 %@",[NSThread currentThread]);
    });
    
    dispatch_block_t block3 = dispatch_block_create(0, ^{
        NSLog(@"block3 %@",[NSThread currentThread]); // è¯¥ä»£ç å—å–æ¶ˆæ‰§è¡Œ
    });
    
    dispatch_async(queue, block1);
    dispatch_async(queue, block2);
    dispatch_block_cancel(block3);
}
```



æ–¹æ¡ˆ2ï¼š**å®šä¹‰å¤–éƒ¨å˜é‡ï¼Œç”¨äºæ ‡è®° block æ˜¯å¦éœ€è¦å–æ¶ˆ**

è¯¥æ–¹æ³•å…¶å®å°±æ˜¯åœ¨å‚è€ƒ **NSOperation** çŠ¶æ€æœºåˆ¶ï¼Œåœ¨æ‰§è¡Œ block å‰å…ˆæ£€æŸ¥æ ‡è®°å˜é‡ `isCancelled == YES `ã€‚

åœ¨ block ä¸­åŠæ—¶çš„æ£€æµ‹æ ‡è®°å˜é‡ï¼Œå½“å‘ç°éœ€è¦å–æ¶ˆæ—¶ï¼Œç»ˆæ­¢åç»­æ“ä½œã€‚

```objective-c
- (void)gcdCancel{
    
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    __block BOOL isCancelled = NO;
    
    dispatch_async(queue, ^{
        NSLog(@"ä»»åŠ¡1 %@",[NSThread currentThread]);
    });
    
    dispatch_async(queue, ^{
        NSLog(@"ä»»åŠ¡2 %@",[NSThread currentThread]);
    });
    
    dispatch_async(queue, ^{
        NSLog(@"ä»»åŠ¡3 %@",[NSThread currentThread]);
        isCancelled = YES;
    });
    
    dispatch_async(queue, ^{
        // æ¨¡æ‹Ÿï¼šçº¿ç¨‹ç­‰å¾…3ç§’ï¼Œç¡®ä¿ä»»åŠ¡3 æ ‡è®°å˜é‡isCancelledï¼YESå®Œæˆ
        sleep(3);
        if(isCancelled){
            NSLog(@"ä»»åŠ¡4å·²è¢«å–æ¶ˆ %@",[NSThread currentThread]);
        }else{
            NSLog(@"ä»»åŠ¡4 %@",[NSThread currentThread]);
        }
    });
}
```



æ—¢ç„¶æåˆ°äº†  NSOperation çš„ **- (void)cancel;** æ–¹æ³•ï¼Œé‚£å°±å±•å¼€è®²ä¸€ä¸‹ã€‚æ²¡æœ‰ä»€ä¹ˆæ¯”å®˜æ–¹æ–‡æ¡£æ›´æ‡‚ğŸ˜ï¼š

> This method does not force your operation code to stop. Instead, it updates the objectâ€™s internal flags to reflect the change in state. If the operation has already finished executing, this method has no effect. Canceling an operation that is currently in an operation queue, but not yet executing, makes it possible to remove the operation from the queue sooner than usual. 
>
> In macOS 10.6 and later, if an operation is in a queue but waiting on unfinished dependent operations, those operations are subsequently ignored. Because it is already cancelled, this behavior allows the operation queue to call the operationâ€™s `start` method sooner and clear the object out of the queue. If you cancel an operation that is not in a queue, this method immediately marks the object as finished. In each case, marking the object as ready or finished results in the generation of the appropriate KVO notifications. 
>
> In versions of macOS prior to 10.6, an operation object remains in the queue until all of its dependencies are removed through the normal processes. Thus, the operation must wait until all of its dependent operations finish executing or are themselves cancelled and have their `start` method called. 
>
> For more information on what you must do in your operation objects to support cancellation, see [Responding to the Cancel Command](doc://com.apple.documentation/documentation/foundation/nsoperation?language=objc#1661262).


### 4. JSON æ•°æ®è§£æ

> Error Domain=NSCocoaErrorDomain Code=3840 "Garbage at end." UserInfo={NSDebugDescription=Garbage at end.}

ä½¿ç”¨ `NSJSONSerialization` å°†å­—ç¬¦ä¸²è½¬å­—å…¸
æ­¥éª¤ä¸€: å°†å­—ç¬¦ä¸²ä½¿ç”¨`NSUTF8StringEncoding`ç¼–ç æ ¼å¼è½¬æ¢ä¸º`NSData`
æ­¥éª¤äºŒ: å°†`data`ä½¿ç”¨`NSJSONSerialization` è½¬æ¢ä¸ºå¯¹è±¡
æ­¥éª¤ä¸‰: æŠŠå¯¹è±¡ä¸º`NSDictionary`

ä»£ç 

```
/// ps. è¿‡æ»¤å­—ç¬¦ä¸²ä¸­çš„éæ³•å­—ç¬¦ æ§åˆ¶å­—ç¬¦
// å»æ‰é¦–å°¾çš„ç©ºç™½å­—ç¬¦
result = [result stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]];
// å»é™¤æ‰æ§åˆ¶å­—ç¬¦
result = [result stringByTrimmingCharactersInSet:[NSCharacterSet controlCharacterSet]];

NSData *jsonData = [result dataUsingEncoding:NSUTF8StringEncoding];
NSError *error = nil;
id  dicData = [NSJSONSerialization JSONObjectWithData:jsonData
                                              options:kNilOptions
                                                error:&error];
if ([dicData isKindOfClass:[NSDictionary class]]) {
    NSDictionary *dict = (NSDictionary *)dicData;
}

```



##### 4.1 nil/Nil/NULL/NSNull çš„åŒºåˆ«

**[`objc.h`](https://opensource.apple.com/source/objc4/)**

```objective-c
#ifndef Nil
# if __has_feature(cxx_nullptr)
#   define Nil nullptr
# else
#   define Nil __DARWIN_NULL
# endif
#endif

#ifndef nil
# if __has_feature(cxx_nullptr)
#   define nil nullptr
# else
#   define nil __DARWIN_NULL
# endif
#endif
```



**`_types.h`**

```c
#ifdef __cplusplus
#ifdef __GNUG__
#define __DARWIN_NULL __null
#else /* ! __GNUG__ */
#ifdef __LP64__
#define __DARWIN_NULL (0L)
#else /* !__LP64__ */
#define __DARWIN_NULL 0
#endif /* __LP64__ */
#endif /* __GNUG__ */
#else /* ! __cplusplus */
#define __DARWIN_NULL ((void *)0)
#endif /* __cplusplus */
```



é c++ ä»£ç çš„`__DARWIN_NULL` æœ€ç»ˆå®šä¹‰

```c
#define __DARWIN_NULL ((void *)0)
```

å³ `nil` å’Œ `Nil`æœ¬è´¨ä¸Šæ˜¯ï¼š `(void *)0`



`nil` ç”¨äºè¡¨ç¤º oc ä¸­å¯¹è±¡çš„æŒ‡é’ˆä¸ºç©º

```objective-c
NSString *str = nil;
```

`Nil` ç”¨äºè¡¨ç¤º oc ç±» `Class` ç±»å‹çš„å˜é‡å€¼ä¸ºç©º

```objective-c
Class myClass = Nil;
```



**`_types/_null.h`**

```c
#ifndef NULL
#include <sys/_types.h> /* __DARWIN_NULL */
#define NULL  __DARWIN_NULL
#endif  /* NULL */
```

æ‰€ä»¥ï¼Œ NULL ä¹Ÿæ˜¯ `(void *)0`ã€‚è¡¨ç¤º C æŒ‡é’ˆä¸ºç©º

```c
char *str = NULL;
```

**`Foundation/NSNull.h`**

```objective-c
#import <Foundation/NSObject.h>

NS_ASSUME_NONNULL_BEGIN

@interface NSNull : NSObject <NSCopying, NSSecureCoding>

+ (NSNull *)null;

@end

NS_ASSUME_NONNULL_END
```

è¯¥ç±»å¸¸ç”¨äºåœ¨é›†åˆå¯¹è±¡ä¸­ä¿å­˜ä¸€ä¸ªç©ºçš„ç«™ä½å¯¹è±¡ã€‚

```objective-c
NSArray *arr = [NSArray arrayWithObjects:@"a",@"b",[NSNull null],@"c"];
// [a, b, "<null>", c]
```

vs.

```objective-c
NSArray *arr = [NSArray arrayWithObjects:@"a",@"b",nil,@"c"];
// [a, b] nilä¹‹åçš„å¯¹è±¡ä¼šè¢«æŠ›å¼ƒ
```



ç™½è¯ï¼šä½ ä¸€çœ‹åˆ°ç”¨åˆ°äº†`NULL`å°±çŸ¥é“è¿™æ˜¯ä¸ª**C**æŒ‡é’ˆï¼Œçœ‹åˆ°`nil`å°±çŸ¥é“è¿™æ˜¯ä¸ª**Objective-C**å¯¹è±¡ï¼Œçœ‹åˆ°`Nil`å°±çŸ¥é“è¿™æ˜¯ä¸ª**Class**ç±»å‹çš„æ•°æ®ã€‚



##### 4.2 åˆ¤æ–­ NSArray å’Œ NSDictionary æ˜¯å¦ä¸ºç©º

æ‰€ä»¥ï¼Œ

```objective-c
if (array != nil && ![array isKindOfClass:[NSNull class]] && array.count != 0) {}
  
if (dic != nil && ![dic isKindOfClass:[NSNull class]] && dic.count != 0) {}
```



##### 4.3 NSString æ˜¯å¦ä¸ºç©º

```objective-c
// [NSString isBlankString: str];

+ (BOOL)isBlankString:(NSString *)str {
    NSString *string = str;
    if (string == nil || string == NULL) {
        return YES;
    }
    if ([string isKindOfClass:[NSNull class]]) {
        return YES;
    }
    // å»æ‰ç©ºæ ¼ä¹‹åé•¿åº¦æ˜¯å¦ä¸º0 
    if ([[string stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceCharacterSet]] length]==0) {
        return YES;
    }
    
    return NO;
}
```

æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªNSString æ‰©å±•çš„**ç±»æ–¹æ³•**ã€‚

å¦‚æœæ˜¯å¯¹è±¡æ–¹æ³•å‘¢ï¼Ÿ

`[str isBlankString]`çš„æ—¶å€™ï¼Œstrçš„å€¼ä¸ºnilï¼Œstræ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›ä¸ºnilã€‚è€Œnilå¯¹åº”çš„å€¼ä¸º0ï¼Œå†å¯¹åº”åˆ°Boolä¸Šå°±æ˜¯NOã€‚æ‰€ä»¥ä¸€ä¸ªæœ¬æ¥ä¸ºç©ºçš„å­—ç¬¦ä¸²å°±è¢«åˆ¤æ–­ä¸ºä¸ä¸ºç©ºäº†

> **å‘é€ç»™ nil çš„æ¶ˆæ¯ï¼Œå°†è¿”å› 0ï¼ˆ**åœ¨ Objective-C ä¸­å‘ nil å‘é€æ¶ˆæ¯æ˜¯å®Œå…¨æœ‰æ•ˆçš„â€”â€”åªæ˜¯åœ¨è¿è¡Œæ—¶ä¸ä¼šæœ‰ä»»ä½•ä½œç”¨**ï¼‰**
>
> ä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªç±»å‹:
>
> - å¦‚æœä¸€ä¸ªæ–¹æ³•è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œ
>
>   é‚£ä¹ˆå‘é€ç»™nilçš„æ¶ˆæ¯å°†è¿”å›0(nil)ã€‚ä¾‹å¦‚ï¼š
>
>   - `Student * xiaoming = [[Student primary] goodStudent];`
>   - å¦‚æœ primary è¿”å›çš„å¯¹è±¡ä¸º nilï¼Œé‚£ä¹ˆå‘é€ç»™ nil çš„æ¶ˆæ¯ goodStudent ä¹Ÿå°†è¿”å› nilã€‚
>
> - å¦‚æœæ–¹æ³•è¿”å›å€¼ä¸ºæŒ‡é’ˆç±»å‹ï¼Œå…¶æŒ‡é’ˆå¤§å°ä¸ºå°äºæˆ–è€…ç­‰äº`sizeof(void*)`ï¼Œ`float`ï¼Œ`double`ï¼Œ`long double` æˆ–è€… `long long` çš„æ•´å‹æ ‡é‡ï¼Œå‘é€ç»™ nil çš„æ¶ˆæ¯å°†è¿”å›0ã€‚
>
> - å¦‚æœæ–¹æ³•è¿”å›å€¼ä¸ºç»“æ„ä½“,**å‘é€ç»™ nil çš„æ¶ˆæ¯å°†è¿”å›0**ã€‚**ç»“æ„ä½“ä¸­å„ä¸ªå­—æ®µçš„å€¼å°†éƒ½æ˜¯0**ã€‚
>
> - å¦‚æœæ–¹æ³•çš„è¿”å›å€¼ä¸æ˜¯ä¸Šè¿°æåˆ°çš„å‡ ç§æƒ…å†µï¼Œ**é‚£ä¹ˆå‘é€ç»™ nil çš„æ¶ˆæ¯çš„è¿”å›å€¼å°†æ˜¯æœªå®šä¹‰çš„**ã€‚



å†ç®€å•èŠä¸‹æ¶ˆæ¯æœºåˆ¶è§£é‡Šä¸€ä¸‹å‘nilå‘é€æ¶ˆæ¯ä¸ºä»€ä¹ˆä¸crash

```c
/* Types */

#if !OBJC_TYPES_DEFINED

/// An opaque type that represents a method in a class definition.
typedef struct objc_method *Method;

/// An opaque type that represents an instance variable.
typedef struct objc_ivar *Ivar;

/// An opaque type that represents a category.
typedef struct objc_category *Category;

/// An opaque type that represents an Objective-C declared property.
typedef struct objc_property *objc_property_t;

struct objc_class {
    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;

#if !__OBJC2__
    Class _Nullable super_class                              OBJC2_UNAVAILABLE;
    const char * _Nonnull name                               OBJC2_UNAVAILABLE;
    long version                                             OBJC2_UNAVAILABLE;
    long info                                                OBJC2_UNAVAILABLE;
    long instance_size                                       OBJC2_UNAVAILABLE;
    struct objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;
    struct objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;
    struct objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;
    struct objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;
#endif

} OBJC2_UNAVAILABLE;
/* Use `Class` instead of `struct objc_class *` */

#endif
```

> objc åœ¨å‘ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯æ—¶ï¼Œruntime ä¼šæ ¹æ®å¯¹è±¡çš„ isa æŒ‡é’ˆæ‰¾åˆ°è¯¥å¯¹è±¡å®é™…æ‰€å±çš„ç±»ï¼Œç„¶ååœ¨è¯¥ç±»ä¸­çš„æ–¹æ³•åˆ—è¡¨ä»¥åŠå…¶çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­å¯»æ‰¾æ–¹æ³•æ‰§è¡Œï¼Œç„¶ååœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œobjc_msgSend æ–¹æ³•ä¸ä¼šè¿”å›å€¼ï¼Œæ‰€è°“çš„è¿”å›å†…å®¹éƒ½æ˜¯å…·ä½“è°ƒç”¨æ—¶æ‰§è¡Œçš„ã€‚é‚£ä¹ˆï¼Œå¦‚æœåƒä¸€ä¸ª nil å¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œé¦–å…ˆåœ¨å¯»æ‰¾å¯¹è±¡çš„ isa æŒ‡é’ˆçš„æ—¶å€™å°±æ˜¯ 0 åœ°å€è¿”å›äº†ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚

[Objective-C Runtime](http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/) è¿™ç¯‡æ–‡ç« å€¼å¾—ä¸€è¯»ã€‚

### 5 becomeFirstResponder æ— æ³•è°ƒèµ·é”®ç›˜

1. canBecomeFirstResponder å‡½æ•°è¿”å›

   > This method returns `NO` by default. Subclasses must override this method and return `YES` to be able to become first responder. 
   >
   > Do not call this method on a view that is not currently in the active view hierarchy. The result is undefined.

2. æ˜¯å¦åœ¨ä¸»çº¿ç¨‹

3. æ˜¯å¦æœ‰å…¶ä»– firstResponder æ‹’ç» resign

> \- (BOOL)becomeFirstResponder
>
> Asks UIKit to make this object the first responder in its window.
>
> Call this method when you want the current object to be the first responder. Calling this method is not a guarantee that the object will become the first responder. UIKit asks the current first responder to resign as first responder, which it might not. If it does, UIKit calls this object's `canBecomeFirstResponder` method, which returns `NO` by default. If this object succeeds in becoming the first responder, subsequent events targeting the first responder are delivered to this object first and UIKit attempts to display the object's input view, if any. 
>
> Never call this method on a view that is not part of an active view hierarchy. You can determine whether the view is onscreen, by checking its `window` property. If that property contains a valid window, it is part of an active view hierarchy. If that property is `nil`, the view is not part of a valid view hierarchy.
>
> You can override this method in your custom responders to update your object's state or perform some action such as highlighting the selection. If you override this method, you must call `super` at some point in your implementation.



### 6 ç”¨@propertyå£°æ˜çš„NSStringï¼ˆæˆ–NSArrayï¼ŒNSDictionaryï¼‰ç»å¸¸ä½¿ç”¨copyå…³é”®å­—ï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚æœæ”¹ç”¨strongå…³é”®å­—ï¼Œå¯èƒ½é€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ

> 1. å› ä¸ºçˆ¶ç±»æŒ‡é’ˆå¯ä»¥æŒ‡å‘å­ç±»å¯¹è±¡,ä½¿ç”¨ copy çš„ç›®çš„æ˜¯ä¸ºäº†è®©æœ¬å¯¹è±¡çš„å±æ€§ä¸å—å¤–ç•Œå½±å“,ä½¿ç”¨ copy æ— è®ºç»™æˆ‘ä¼ å…¥æ˜¯ä¸€ä¸ªå¯å˜å¯¹è±¡è¿˜æ˜¯ä¸å¯å¯¹è±¡,æˆ‘æœ¬èº«æŒæœ‰çš„å°±æ˜¯ä¸€ä¸ªä¸å¯å˜çš„å‰¯æœ¬.
> 2. å¦‚æœæˆ‘ä»¬ä½¿ç”¨æ˜¯ strong ,é‚£ä¹ˆè¿™ä¸ªå±æ€§å°±æœ‰å¯èƒ½æŒ‡å‘ä¸€ä¸ªå¯å˜å¯¹è±¡,å¦‚æœè¿™ä¸ªå¯å˜å¯¹è±¡åœ¨å¤–éƒ¨è¢«ä¿®æ”¹äº†,é‚£ä¹ˆä¼šå½±å“è¯¥å±æ€§.
>
> copy æ­¤ç‰¹è´¨æ‰€è¡¨è¾¾çš„æ‰€å±å…³ç³»ä¸ strong ç±»ä¼¼ã€‚ç„¶è€Œè®¾ç½®æ–¹æ³•å¹¶ä¸ä¿ç•™æ–°å€¼ï¼Œè€Œæ˜¯å°†å…¶â€œæ‹·è´â€ (copy)ã€‚ å½“å±æ€§ç±»å‹ä¸º NSString æ—¶ï¼Œç»å¸¸ç”¨æ­¤ç‰¹è´¨æ¥ä¿æŠ¤å…¶å°è£…æ€§ï¼Œå› ä¸ºä¼ é€’ç»™è®¾ç½®æ–¹æ³•çš„æ–°å€¼æœ‰å¯èƒ½æŒ‡å‘ä¸€ä¸ª NSMutableString ç±»çš„å®ä¾‹ã€‚è¿™ä¸ªç±»æ˜¯ NSString çš„å­ç±»ï¼Œè¡¨ç¤ºä¸€ç§å¯ä¿®æ”¹å…¶å€¼çš„å­—ç¬¦ä¸²ï¼Œæ­¤æ—¶è‹¥æ˜¯ä¸æ‹·è´å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè®¾ç½®å®Œå±æ€§ä¹‹åï¼Œå­—ç¬¦ä¸²çš„å€¼å°±å¯èƒ½ä¼šåœ¨å¯¹è±¡ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹é­äººæ›´æ”¹ã€‚æ‰€ä»¥ï¼Œè¿™æ—¶å°±è¦æ‹·è´ä¸€ä»½â€œä¸å¯å˜â€ (immutable)çš„å­—ç¬¦ä¸²ï¼Œç¡®ä¿å¯¹è±¡ä¸­çš„å­—ç¬¦ä¸²å€¼ä¸ä¼šæ— æ„é—´å˜åŠ¨ã€‚åªè¦å®ç°å±æ€§æ‰€ç”¨çš„å¯¹è±¡æ˜¯â€œå¯å˜çš„â€ (mutable)ï¼Œå°±åº”è¯¥åœ¨è®¾ç½®æ–°å±æ€§å€¼æ—¶æ‹·è´ä¸€ä»½ã€‚



```objective-c
NSMutableString *mString = [NSMutableString stringWithString:@"mutable string"];
NSString *string = [mString copy];

/*
(lldb) p mString
(__NSCFString *) $1 = 0x00006000038b56b0 @"mutable string"
(lldb) p string
(__NSCFString *) $2 = 0x00006000036cc940 @"mutable string"
*/

[mString appendString:@" deep!"];
/*
(lldb) p mString
(__NSCFString *) $0 = 0x0000600000871530 @"mutable string deep!"
(lldb) p string
(__NSCFString *) $1 = 0x00006000006013a0 @"mutable string"
*/
```

- `mString` å’Œ `string` çš„å†…å­˜åœ°å€ä¸åŒï¼Œæ˜¯å†…å®¹æ‹·è´ï¼ˆæ·±æ‹·è´ï¼‰ã€‚

- `mString` ä¿®æ”¹ä»¥åï¼Œ`string` å¹¶æ²¡æœ‰æ”¹å˜ã€‚

ç”¨ `@property` å£°æ˜ `NSString / NSArray / NSDictionary` ç»å¸¸ä½¿ç”¨` copy `å…³é”®å­—ï¼Œæ˜¯å› ä¸ºä»–ä»¬æœ‰å¯¹åº”çš„å¯å˜ç±»å‹ï¼š`NSMutableString / NSMutableArray / NSMutableDictionary` ï¼Œä»–ä»¬ä¹‹é—´å¯èƒ½è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œä¸ºç¡®ä¿å¯¹è±¡ä¸­çš„å­—ç¬¦ä¸²å€¼ä¸ä¼šæ— æ„é—´å˜åŠ¨ï¼Œåº”è¯¥åœ¨è®¾ç½®æ–°å±æ€§å€¼æ—¶æ‹·è´ä¸€ä»½ã€‚

æ­¤å¤–ï¼Œ

```objective-c
NSString *string = @"string";
string = @"string assignment";

/*
(lldb) p string
(__NSCFConstantString *) $0 = 0x000000010ea00118 @"string"
(lldb) p string
(__NSCFConstantString *) $1 = 0x000000010ea00138 @"string assignment"
*/
```

è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç¬¬äºŒè¡Œæ˜¯å¯¹ `string` æŒ‡å‘çš„å†…å­˜åœ°å€é‡æ–°èµ‹å€¼ï¼Œå› ä¸ºèµ‹å€¼æ“ä½œç¬¦å·¦è¾¹ `string` æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ`@"sting assignment"` è¿™ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œèµ‹å€¼ç»™`sting`ï¼Œå³æ­¤å¤„ä¿®æ”¹çš„æ—¶å†…å­˜åœ°å€ã€‚

è‡³äºæ˜¯**æ·±**å¤åˆ¶è¿˜æ˜¯**æµ…**å¤åˆ¶ï¼Œè¿›è¡Œæ‹·è´æ“ä½œæ—¶ï¼Œè¢«æ‹·è´çš„æ˜¯æŒ‡é’ˆè¿˜æ˜¯å†…å®¹å³å¯ã€‚



### 7 loadå›¾ç‰‡

### 7.1 UIImage

#### å‘

- `imageNamed`ä¸è¦ä½¿ç”¨ï¼Œå› ä¸ºï¼š
  - `imageNamed`æ˜¯ä¼šæŠŠè¯»å–åˆ°çš„`image`å­˜åœ¨æŸä¸ªç¼“å­˜é‡Œé¢ï¼ˆè¿™æ ·å†…å­˜ç­‰äºå¤šç”¨äº†ä¸€ä»½ï½ï¼‰ï¼Œç¬¬äºŒæ¬¡è¯»å–ç›¸åŒå›¾ç‰‡çš„è¯ç³»ç»Ÿå°±ä¼šç›´æ¥ä»é‚£ä¸ªç¼“å­˜ä¸­è·å–ï¼ˆæ›´å¿«ï¼Ÿï¼‰ï¼Œä»æŸç§æ„ä¹‰ä¸Šå¥½åƒä¸€ç§ä¼˜åŒ–
  - ä½†æ˜¯`imageNamed`è¯»å–åˆ°çš„é‚£ä¸ªå›¾ç‰‡ä¼¼ä¹ä¸ä¼šå› ä¸º`Memory Warning`è€Œé‡Šæ”¾ï¼Œæ‰€ä»¥ç”¨è¿™ä¸ªä¼šå¯¼è‡´åœ¨å†…å­˜ä¸è¶³çš„æ—¶å€™é—ªé€€
- `imageWithContentsOfFile`ä¸è¦ä½¿ç”¨ï¼Œå› ä¸ºï¼š
  - `imageWithContentsOfFile`åˆ™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç›´æ¥çš„è¯»å–ï¼Œä¸ä¼šè¢«å­˜è¿›æŸç¼“å­˜ï¼Œç¬¬äºŒæ¬¡è¯»å–ç›¸åŒå›¾ç‰‡ä¹Ÿå°±æ˜¯é‡æ–°è¯»å–ä¸€éã€‚
  - ä½†æ˜¯`imageWithContentsOfFile`è¯»å–çš„å›¾ç‰‡åœ¨`Memory Warning`çš„æ—¶å€™å°±ä¼šè¢«é‡Šæ”¾ï¼Œç„¶ååªæœ‰å½“å‰åœ¨ç”¨çš„é‚£å‡ ä¸ªä¼šè¢«é‡æ–°è¯»å–ï¼Œæ‰€ä»¥èŠ‚çº¦äº†å†…å­˜ã€‚ä½†è¿™ä¸ªæˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šè¢«é‡Šæ”¾æ‰

#### å»ºè®®

- **å…¨éƒ¨ä½¿ç”¨`[UIImage alloc]`è‡ªå·±ç”³è¯·å†…å­˜æ¥åŠ è½½ï¼Œè‡ªå·±é‡Šæ”¾ï¼Œå°¤å…¶æ˜¯å¤„ç†ç…§ç‰‡å¤§å›¾çš„æ—¶å€™**

### 7.2 æ–¹å‘æ ¡æ­£

#### å‘

- æ¯ä¸ªJPEGå›¾åƒéƒ½ä¼šæœ‰ä¸€ä¸ªæ–¹å‘ï¼Œæ€»å…±ä¼šæœ‰8ä¸ªæ–¹å‘ï¼Œè€ŒC++åœ¨å¤„ç†çš„æ—¶å€™æ˜¯éœ€è¦å°†å›¾åƒå…ˆé¢„æ ¡æ­£ä¸ºæ­£æ–¹å‘ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å‡ºç°å®½é«˜ä¸ä¸€è‡´ç­‰å¯¼è‡´çš„å›¾åƒä¹±ç é—®é¢˜ã€‚

#### å»ºè®®

- å› æ­¤ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬è‡ªå·±æ´¾ç”Ÿäº†ä¸€ä¸ª`UIImage+ImageData.h`æ ¡æ­£æ–¹å‘ã€‚

```objective-c
- (UIImage *)fixOrientation
{
    // No-op if the orientation is already correct.
    if (self.imageOrientation == UIImageOrientationUp) {
        return self;
    }
    
    // We need to calculate the proper transformation to make the image upright.
    // We do it in 2 steps: Rotate if Left/Right/Down, and then flip if Mirrored.
    CGAffineTransform transform = CGAffineTransformIdentity;
    
    switch (self.imageOrientation) {
        case UIImageOrientationDown:
        case UIImageOrientationDownMirrored:
            transform = CGAffineTransformTranslate(transform, self.size.width, self.size.height);
            transform = CGAffineTransformRotate(transform, M_PI);
            break;
            
        case UIImageOrientationLeft:
        case UIImageOrientationLeftMirrored:
            transform = CGAffineTransformTranslate(transform, self.size.width, 0);
            transform = CGAffineTransformRotate(transform, M_PI_2);
            break;
            
        case UIImageOrientationRight:
        case UIImageOrientationRightMirrored:
            transform = CGAffineTransformTranslate(transform, 0, self.size.height);
            transform = CGAffineTransformRotate(transform, -M_PI_2);
            break;
        case UIImageOrientationUp:
        case UIImageOrientationUpMirrored:
            break;
    }
    
    switch (self.imageOrientation) {
        case UIImageOrientationUpMirrored:
        case UIImageOrientationDownMirrored:
            transform = CGAffineTransformTranslate(transform, self.size.width, 0);
            transform = CGAffineTransformScale(transform, -1, 1);
            break;
            
        case UIImageOrientationLeftMirrored:
        case UIImageOrientationRightMirrored:
            transform = CGAffineTransformTranslate(transform, self.size.height, 0);
            transform = CGAffineTransformScale(transform, -1, 1);
            break;
        case UIImageOrientationUp:
        case UIImageOrientationDown:
        case UIImageOrientationLeft:
        case UIImageOrientationRight:
            break;
    }
    
    // Now we draw the underlying CGImage into a new context, applying the transform
    // calculated above.
    CGContextRef ctx = CGBitmapContextCreate(NULL, self.size.width, self.size.height,
                                             CGImageGetBitsPerComponent(self.CGImage), 0,
                                             CGImageGetColorSpace(self.CGImage),
                                             CGImageGetBitmapInfo(self.CGImage));
    CGContextConcatCTM(ctx, transform);
    switch (self.imageOrientation) {
        case UIImageOrientationLeft:
        case UIImageOrientationLeftMirrored:
        case UIImageOrientationRight:
        case UIImageOrientationRightMirrored:
            CGContextDrawImage(ctx, CGRectMake(0, 0, self.size.height, self.size.width), self.CGImage);
            break;
            
        default:
            CGContextDrawImage(ctx, CGRectMake(0, 0, self.size.width, self.size.height), self.CGImage);
            break;
    }
    
    // And now we just create a new UIImage from the drawing context.
    CGImageRef cgimg = CGBitmapContextCreateImage(ctx);
    UIImage *img = [UIImage imageWithCGImage:cgimg];
    CGContextRelease(ctx);
    CGImageRelease(cgimg);
    
    return img;
}
```



### 7.3 ç›¸å†Œä¿å­˜

#### å‘

- ç³»ç»Ÿæä¾›äº†å¾ˆå¤šç§ä¿å­˜`UIImage`çš„æ–¹å¼æ¥ç»™æˆ‘ä»¬ä½¿ç”¨ï¼Œè€Œæ¯”è¾ƒå¸¸è§çš„æœ‰`UIImage`ã€`CGImageRef`å’Œ`NSData`æ ¼å¼ç­‰ã€‚ç»è¿‡æˆ‘ä»¬çš„å®é™…æµ‹è¯•å‘ç°`UIImage`ã€`CGImageRef`ä¼ é€’ç»™ç³»ç»ŸAPIå»ä¿å­˜åˆ°ç›¸å†Œé‡Œçš„æ–¹å¼ï¼Œç³»ç»Ÿéƒ½ä¼šåšä¸€äº›ç”»è´¨çš„æŸè€—
  - TODO è¿™é‡Œæ˜¯ä¸æ˜¯æŠ½ç©ºå†™ä¸€ä¸‹ä»€ä¹ˆæ˜¯â€œç”»è´¨çš„æŸè€—â€ï¼ŒæŸè€—åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿè¦ä¸è¿™ä¹ˆè¯´ç•¥å¹²ï¼Œä¸å¥½è¯æ˜å’Œç†è§£

#### å»ºè®®

- å› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨ä¿å­˜æ—¶éƒ½å¿…é¡»å…ˆè‡ªå·±å°†`UIImage`ç”Ÿæˆ`NSData`ï¼Œç„¶åå†å°†`NSData`ä¼ é€’ç»™ç³»ç»ŸAPIå»ä¿å­˜
- `UIImage`ç”Ÿæˆ`NSData`çš„APIå¦‚ä¸‹
  - ç”Ÿæˆ`jpeg`æ–‡ä»¶çš„æ•°æ®æµï¼š`UIImageJPEGRepresentation`
  - ç”Ÿæˆ`png`æ–‡ä»¶çš„æ•°æ®æµï¼š`UIImagePNGRepresentation`



### 8 M1 ä¸‹Xcode 12.5.1  *Could not find module 'SnapKit' for target 'x86_64-apple-ios-simulator'*

```ruby
post_install do |installer_representation|
    installer_representation.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['SWIFT_VERSION'] = '5.0'
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '10.0'
        config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = "YES"
        # åŠ äº†è¿™ä¸€è¡Œç¼–è¯‘é€šè¿‡äº†
        config.build_settings['VALID_ARCHS'] = 'arm64, arm64e, x86_64'
        # ...
      end
    end
end
```



### 9 Cocoapods 1.9 + æ”¯æŒ `.xcframework`

```ruby
# vendored_frameworks
s.vendored_frameworks = 'Test1lib.xcframework','Test2lib.xcframework'
```

> å¯¹å¤–è¾“å‡ºä¸º XCFramework æ ¼å¼çš„ podspec æ–‡ä»¶ä¿®æ”¹
>
> ```ruby
> #1 spec.source_files = 'Classes/**/*.{h,m}', 'More_Classes/**/*.{h,m}' 
> # 2
> spec.vendored_frameworks = 'MyFramework.framework', 'TheirFramework.xcframework'
> ```
>
> 1 æ³¨é‡Šæ‰
>
> 2 æ–°å¢ xcframework çš„æ”¯æŒ ï¼ˆCocoapods 1.9 +ï¼‰



### 10 EXC_BAD_ACCESS KERN_INVALID_ADDRESS

This crash occurs due to a dangling pointer. When any variable or object is trying to access an object that's already been deallocated, this crash occurs.



### 11 å†…å­˜æ³„æ¼

11.1 viewController ä¸­çš„ NSTimer æ²¡æœ‰è¢«é”€æ¯

11.2 viewController ä¸­çš„ä»£ç†ä¸æ˜¯weakå±æ€§

11.3 viewControllerä¸­blockçš„å¾ªç¯å¼•ç”¨



### 12 copy & mutableCopy

#### 1. å¯¹éé›†åˆç±»å¯¹è±¡çš„ copy æ“ä½œï¼š

å…ˆè¯´ç»“è®º:

**åœ¨éé›†åˆç±»å¯¹è±¡ä¸­ï¼š**

å¯¹ immutable å¯¹è±¡è¿›è¡Œ copy æ“ä½œï¼Œæ˜¯æŒ‡é’ˆå¤åˆ¶ï¼ŒmutableCopy æ“ä½œæ˜¯å†…å®¹å¤åˆ¶ï¼›

å¯¹ mutable å¯¹è±¡è¿›è¡Œ copy å’Œ mutableCopy éƒ½æ˜¯å†…å®¹å¤åˆ¶ã€‚

ç”¨ä»£ç ç®€å•è¡¨ç¤ºå¦‚ä¸‹ï¼š

```objective-c
[immutableObject copy] // æµ…å¤åˆ¶
[immutableObject mutableCopy] //æ·±å¤åˆ¶
[mutableObject copy] //æ·±å¤åˆ¶
[mutableObject mutableCopy] //æ·±å¤åˆ¶
```

æ ¹æ®ä¸Šé¢çš„ç»“è®ºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ€»ç»“å‡ºè§„å¾‹ï¼š

å¯¹äºéé›†åˆç±»å¯¹è±¡è€Œè¨€ï¼Œä»ä¸å¯å˜è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸å¯å˜ï¼Œå› ä¸ºæ²¡å¿…è¦åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡å‡ºæ¥ï¼Œ æ‰€ä»¥æ˜¯æµ…æ‹·è´ã€‚ è€Œä¸å¯å˜ä¸å¯å˜å¯¹è±¡çš„äº’ç›¸è½¬æ¢è¿‡ç¨‹ä¸­ã€ä»ä¸€ä¸ªå¯å˜åˆ°å¦ä¸€ä¸ªå¯å˜ï¼Œ ä¸ºäº†ä¸å½±å“å¯å˜å¯¹è±¡çš„å¯å˜ç‰¹æ€§ï¼Œå¿…é¡»è¦åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡å‡ºæ¥ï¼Œæ‰€ä»¥æ˜¯æ·±æ‹·è´ã€‚

ä¸‹é¢è¯¦ç»†è®²ä¸‹:

æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š

```objective-c
NSMutableString *string = [NSMutableString stringWithString:@"origin"]; // copy
NSString *stringCopy = [string copy];
```

æŸ¥çœ‹å†…å­˜ï¼Œä¼šå‘ç° stringã€stringCopy å†…å­˜åœ°å€éƒ½ä¸ä¸€æ ·ï¼Œè¯´æ˜æ­¤æ—¶éƒ½æ˜¯åšå†…å®¹æ‹·è´ã€æ·±æ‹·è´ã€‚å³ä½¿ä½ è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

```objective-c
[string appendString:@"origion!"]
```

stringCopy çš„å€¼ä¹Ÿä¸ä¼šå› æ­¤æ”¹å˜ï¼Œä½†æ˜¯å¦‚æœä¸ä½¿ç”¨ copyï¼ŒstringCopy çš„å€¼å°±ä¼šè¢«æ”¹å˜ã€‚ é›†åˆç±»å¯¹è±¡ä»¥æ­¤ç±»æ¨ã€‚ æ‰€ä»¥ï¼Œ

> ç”¨ @property å£°æ˜ NSStringã€NSArrayã€NSDictionary ç»å¸¸ä½¿ç”¨ copy å…³é”®å­—ï¼Œæ˜¯å› ä¸ºä»–ä»¬æœ‰å¯¹åº”çš„å¯å˜ç±»å‹ï¼šNSMutableStringã€NSMutableArrayã€NSMutableDictionaryï¼Œä»–ä»¬ä¹‹é—´å¯èƒ½è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œä¸ºç¡®ä¿å¯¹è±¡ä¸­çš„å­—ç¬¦ä¸²å€¼ä¸ä¼šæ— æ„é—´å˜åŠ¨ï¼Œåº”è¯¥åœ¨è®¾ç½®æ–°å±æ€§å€¼æ—¶æ‹·è´ä¸€ä»½ã€‚

#### 2ã€é›†åˆç±»å¯¹è±¡çš„ copy ä¸ mutableCopy

å…ˆè¯´ç»“è®º:

ä»é›†åˆå†…çš„å…ƒç´ çš„è§’åº¦è€Œè¨€, å¯¹ä»»ä½•é›†åˆå¯¹è±¡(å¯å˜å’Œä¸å¯å˜é›†åˆ)è¿›è¡Œçš„ copy ä¸ mutableCopy æ“ä½œéƒ½å¯ä»¥ç§°ä¹‹ä¸ºæµ…æ‹·è´ã€‚

```objective-c
[immutableCollectionObject copy] // æµ…æ‹·è´
[immutableCollectionObject mutableCopy] //æµ…æ‹·è´
[mutableCollectionObject copy] //æµ…æ‹·è´
[mutableCollectionObject mutableCopy] //æµ…æ‹·è´
```

**å› ä¸ºæ— è®ºæ˜¯è¿›è¡Œ copy è¿˜æ˜¯è¿›è¡Œ mutableCopy é›†åˆå†…éƒ¨çš„å…ƒç´ ä»ç„¶æ˜¯æŒ‡é’ˆæ‹·è´ã€‚**

è€ƒè™‘åˆ°é›†åˆå¯¹è±¡æˆ‘ä»¬æ›´å…³æ³¨å†…éƒ¨å…ƒç´ ï¼Œè€Œéé›†åˆæœ¬èº«ï¼Œæˆ‘æ›´å€¾å‘äºè®¤ä¸ºè¿™ä¸ªå°±æ˜¯æµ…æ‹·è´ã€‚

å½“ç„¶å¦‚æœä»é›†åˆæœ¬èº«çš„è§’åº¦ï¼Œè¿™é‡Œå°±ä¼šæœ‰ä¸€äº›äº‰è®®ï¼Œæˆ‘ä»¬å¯ä»¥è¯¦ç»†è®²ä¸‹ï¼š

é›†åˆç±»å¯¹è±¡æ˜¯æŒ‡ NSArrayã€NSDictionaryã€NSSet ... ä¹‹ç±»çš„å¯¹è±¡ã€‚ä¸‹é¢å…ˆçœ‹é›†åˆç±» immutable å¯¹è±¡ä½¿ç”¨ copy å’Œ mutableCopy çš„ä¸€ä¸ªä¾‹å­ï¼š

```objective-c
NSArray *array = @[@[@"a", @"b"], @[@"c", @"d"]];
NSArray *copyArray = [array copy];
NSMutableArray *mCopyArray = [array mutableCopy];
```

æŸ¥çœ‹å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ° copyArray å’Œ array çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œè€Œ mCopyArray å’Œ array çš„åœ°å€æ˜¯ä¸åŒçš„ã€‚è¯´æ˜ copy æ“ä½œè¿›è¡Œäº†æŒ‡é’ˆæ‹·è´ï¼ŒmutableCopy è¿›è¡Œäº†å†…å®¹æ‹·è´ã€‚ä½†éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼šæ­¤å¤„çš„å†…å®¹æ‹·è´ï¼Œä»…ä»…æ˜¯æ‹·è´ array è¿™ä¸ªå¯¹è±¡ï¼Œarray é›†åˆå†…éƒ¨çš„å…ƒç´ ä»ç„¶æ˜¯æŒ‡é’ˆæ‹·è´ã€‚è¿™å’Œä¸Šé¢çš„éé›†åˆ immutable å¯¹è±¡çš„æ‹·è´è¿˜æ˜¯æŒºç›¸ä¼¼çš„ï¼Œé‚£ä¹ˆmutableå¯¹è±¡çš„æ‹·è´ä¼šä¸ä¼šç±»ä¼¼å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹ï¼Œçœ‹ mutable å¯¹è±¡æ‹·è´çš„ä¾‹å­ï¼š

```objective-c
NSMutableArray *array = [NSMutableArray arrayWithObjects:[NSMutableString stringWithString:@"a"],@"b",@"c",nil];
NSArray *copyArray = [array copy];
NSMutableArray *mCopyArray = [array mutableCopy];
```

æŸ¥çœ‹å†…å­˜ï¼Œå¦‚æˆ‘ä»¬æ‰€æ–™ï¼ŒcopyArrayã€mCopyArrayå’Œ array çš„å†…å­˜åœ°å€éƒ½ä¸ä¸€æ ·ï¼Œè¯´æ˜ copyArrayã€mCopyArray éƒ½å¯¹ array è¿›è¡Œäº†å†…å®¹æ‹·è´ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š

åœ¨é›†åˆç±»å¯¹è±¡ä¸­ï¼Œå¯¹ immutable å¯¹è±¡è¿›è¡Œ copyï¼Œæ˜¯æŒ‡é’ˆå¤åˆ¶ï¼Œ mutableCopy æ˜¯å†…å®¹å¤åˆ¶ï¼›å¯¹ mutable å¯¹è±¡è¿›è¡Œ copy å’Œ mutableCopy éƒ½æ˜¯å†…å®¹å¤åˆ¶ã€‚ä½†æ˜¯ï¼šé›†åˆå¯¹è±¡çš„å†…å®¹å¤åˆ¶ä»…é™äºå¯¹è±¡æœ¬èº«ï¼Œå¯¹è±¡å…ƒç´ ä»ç„¶æ˜¯æŒ‡é’ˆå¤åˆ¶ã€‚ç”¨ä»£ç ç®€å•è¡¨ç¤ºå¦‚ä¸‹ï¼š

```objective-c
[immutableCollectionObject copy] // æµ…æ‹·è´
[immutableCollectionObject mutableCopy] //æµ…æ‹·è´ï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºâ€œå•å±‚æ·±æ‹·è´â€ã€‚
[mutableCollectionObject copy] //æµ…æ‹·è´ï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºâ€œå•å±‚æ·±æ‹·è´â€ã€‚
[mutableCollectionObject mutableCopy] //æµ…æ‹·è´ï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºâ€œå•å±‚æ·±æ‹·è´â€ã€‚
```

è¿™ä¸ªä»£ç ç»“è®ºå’Œéé›†åˆç±»çš„ç»“è®ºæœ‰åŒºåˆ«ï¼Œæ³¨æ„åˆ†è¾¨ã€‚

##### æ³¨æ„ï¼šâ€œæ·±æ‹·è´â€å‰é¢ä¸ºä»€ä¹ˆè¦åŠ ä¸€ä¸ªâ€œå•å±‚â€? 

åŸå› å¦‚ä¸‹ï¼šå¯¹äºé›†åˆå¯¹è±¡çš„ copy æ“ä½œæ˜¯å¦å±äºæ·±æ‹·è´è¿™é‡Œæœ‰äº‰è®®ï¼Œå› ä¸º copy æ“ä½œåï¼Œé›†åˆå¯¹è±¡å†…éƒ¨çš„å…ƒç´ å®é™…å¹¶æ²¡æœ‰å˜æ›´æŒ‡é’ˆåœ°å€ï¼Œæ‰€ä»¥ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼Œé›†åˆå¯¹è±¡çš„ copy æ“ä½œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºæµ…æ‹·è´ã€‚ä¸Šæ–‡ä¸­ï¼Œæ‰€è°“çš„æ·±æ‹·è´ï¼Œæ²¡æœ‰è€ƒè™‘é›†åˆå†…éƒ¨å…ƒç´ å±‚é¢ï¼Œä»…ä»…è€ƒè™‘äº†è¯¥é›†åˆå¯¹è±¡çš„æŒ‡é’ˆã€‚æ‰€ä»¥ä»…ä»…æ˜¯â€œå•å±‚æ·±å¤åˆ¶â€ï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºæµ…æ‹·è´ã€‚ä½†è€ƒè™‘åˆ°é›†åˆå¯¹è±¡æˆ‘ä»¬æ›´å…³æ³¨å…ƒç´ ï¼Œè€Œéé›†åˆæœ¬èº«ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºè®¤ä¸ºè¿™ä¸ªå°±æ˜¯æµ…æ‹·è´ã€‚

#### 12 NSDictionaryM objectForKeyedSubscript å´©æºƒé—®é¢˜

```objective-c
Exception Type:  EXC_BAD_ACCESS (SIGSEGV)
Exception Subtype: KERN_INVALID_ADDRESS at 0x00006ba3ac2fc1c0
VM Region Info: 0x6ba3ac2fc1c0 is not in any region.  Bytes after previous region: 118339438363073  
      REGION TYPE                      START - END             [ VSIZE] PRT/MAX SHRMOD  REGION DETAIL
      MALLOC_NANO            0000000280000000-00000002a0000000 [512.0M] rw-/rwx SM=PRV  
--->  
      UNUSED SPACE AT END

Termination Signal: Segmentation fault: 11
Termination Reason: Namespace SIGNAL, Code 0xb
Terminating Process: exc handler [1920]
Triggered by Thread:  4

Thread 4 name:  Dispatch queue: com.meitu.ecom.DemoQueue
Thread 4 Crashed:
0   libobjc.A.dylib               0x0000000216110d68 objc_msgSend + 8
1   CoreFoundation                0x0000000216e13b60 -[__NSDictionaryM objectForKeyedSubscript:] + 212
2   Demo                          0x000000010816d0d8 -[Manager clientsForKey:] + 60215512 
```

å¤šçº¿ç¨‹å¯¹NSMutableDictionaryå–å€¼æ—¶ä¼šå¶ç°è¿™ä¸ªbugã€‚åŸå› ï¼š
è¿™é‡Œçš„é—®é¢˜ä¸çº¿ç¨‹æœ‰å…³ã€‚NSMutableDictionary ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å®ƒæ˜¯åœ¨åå°çº¿ç¨‹ä¸Šæ›´æ–°çš„ï¼Œä½†æ˜¯ä»£ç æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šè°ƒç”¨çš„ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1. å°†è¿™äº›è°ƒç”¨åŒ…è£…åœ¨ @synchronised ä¸­
2. è¯»å–å­—å…¸æ—¶ä½¿ç”¨ copy



### 13 Container ç±»å‹å’Œ NSString ç±»å‹å¸¸è§ crash

```objc
(1) [aMutableDictionary setObject:nil forKey:]; // object can not be nil.

(2) [aString hasSuffix:nil]; // nil argument crash.
    [aString hasPrefix:nil]; // nil argument crash.

(3) aString = [NSMutableString stringWithString:nil]; // nil argument crash.

(4) aString = [[NSString alloc] initWithString:nil]; // nil argument crash.

(5) aURL = [NSURL fileURLWithPath:nil]; // nil argument crash.

```



---

---

### 1 é€šè¿‡ rvm å®‰è£… ruby

```sh
âœ  ~ rvm install 2.7
Searching for binary rubies, this might take some time.
No binary rubies available for: osx/11.5/arm64/ruby-2.7.2.
Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.
Checking requirements for osx.
Certificates bundle '/usr/local/etc/openssl@1.1/cert.pem' is already up to date.
Requirements installation successful.
Installing Ruby from source to: /Users/kaili/.rvm/rubies/ruby-2.7.2, this may take a while depending on your cpu(s)...
ruby-2.7.2 - #downloading ruby-2.7.2, this may take a while depending on your connection...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 14.0M  100 14.0M    0     0  1102k      0  0:00:13  0:00:13 --:--:-- 1419k
ruby-2.7.2 - #extracting ruby-2.7.2 to /Users/kaili/.rvm/src/ruby-2.7.2 - please wait
ruby-2.7.2 - #configuring - please wait
ruby-2.7.2 - #post-configuration - please wait
ruby-2.7.2 - #compiling - please wait
Error running '__rvm_make -j8',
please read /Users/kaili/.rvm/log/1651922447_ruby-2.7.2/make.log

There has been an error while running make. Halting the installation.
```

è§£å†³ï¼š`arch -x86_64 rvm install 2.7`

